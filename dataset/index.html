<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.jkobject.com/scdataloader/dataset/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>dataset - scdataloader</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "dataset";
        var mkdocs_page_input_path = "dataset.md";
        var mkdocs_page_url = "/scdataloader/dataset/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../scdataloader.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Example notebooks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/1_download_and_preprocess/">one-off preparation and download of the database (optional)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/2_create_dataloader/">Create the dataloader</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">documentation</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">dataset</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#scdataloader.data.Dataset">Dataset</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scdataloader.data.Dataset.define_hierarchies">define_hierarchies</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scdataloader.data.Dataset.get_label_cats">get_label_cats</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scdataloader.data.Dataset.get_unseen_mapped_dataset_elements">get_unseen_mapped_dataset_elements</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scdataloader.data.SimpleAnnDataset">SimpleAnnDataset</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../preprocess/">preprocess</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../utils/">utils</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../datamodule/">datamodule</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../collator/">collator</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">scdataloader</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">documentation</li>
      <li class="breadcrumb-item active">dataset</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="documentation-for-dataset">Documentation for <code>Dataset</code></h1>


<div class="doc doc-object doc-class">



<h2 id="scdataloader.data.Dataset" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">scdataloader</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.utils.data.Dataset">Dataset</span></code></p>



        <p>PyTorch Dataset for loading single-cell data from a LaminDB Collection.</p>
<p>This class wraps LaminDB's MappedCollection to provide additional features:
- Management of hierarchical ontology labels (cell type, tissue, disease, etc.)
- Automatic encoding of categorical labels to integers
- Multi-species gene handling with unified gene indexing
- Optional metacell aggregation and KNN neighbor retrieval</p>
<p>The dataset lazily loads data from storage, making it memory-efficient for
large collections spanning multiple files.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>lamin_dataset</code></b>
                  (<code><span title="lamindb.Collection">Collection</span></code>)
              –
              <div class="doc-md-description">
                <p>LaminDB Collection containing the artifacts to load.</p>
              </div>
            </li>
            <li>
              <b><code>genedf</code></b>
                  (<code><span title="pandas.DataFrame">DataFrame</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>DataFrame with gene information, indexed by gene ID
with an 'organism' column. If None, automatically loaded based on organisms
in the dataset. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>clss_to_predict</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code><span title="list">list</span>()</code>
)
              –
              <div class="doc-md-description">
                <p>Observation columns to encode as prediction
targets. These will be integer-encoded in the output. Defaults to [].</p>
              </div>
            </li>
            <li>
              <b><code>hierarchical_clss</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code><span title="list">list</span>()</code>
)
              –
              <div class="doc-md-description">
                <p>Observation columns with hierarchical
ontology structure. These will have their ancestry relationships computed
using Bionty. Supported columns:
- "cell_type_ontology_term_id"
- "tissue_ontology_term_id"
- "disease_ontology_term_id"
- "development_stage_ontology_term_id"
- "assay_ontology_term_id"
- "self_reported_ethnicity_ontology_term_id"
Defaults to [].</p>
              </div>
            </li>
            <li>
              <b><code>join_vars</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>How to join variables across artifacts.
"inner" for intersection, "outer" for union, None for no joining.
Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>metacell_mode</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>0.0</code>
)
              –
              <div class="doc-md-description">
                <p>Probability of returning aggregated metacell
expression instead of single-cell. Defaults to 0.0.</p>
              </div>
            </li>
            <li>
              <b><code>get_knn_cells</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to include k-nearest neighbor cell
expression in the output. Requires precomputed neighbors in the data.
Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>store_location</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Directory path to cache computed indices.
Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>force_recompute_indices</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Force recomputation of cached data.
Defaults to False.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Attributes:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>mapped_dataset</code></b>
                  (<code><span title="scdataloader.mapped.MappedCollection">MappedCollection</span></code>)
              –
              <div class="doc-md-description">
                <p>Underlying mapped collection for data access.</p>
              </div>
            </li>
            <li>
              <b><code>genedf</code></b>
                  (<code><span title="pandas.DataFrame">DataFrame</span></code>)
              –
              <div class="doc-md-description">
                <p>Gene information DataFrame.</p>
              </div>
            </li>
            <li>
              <b><code>organisms</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>)
              –
              <div class="doc-md-description">
                <p>List of organism ontology term IDs in the dataset.</p>
              </div>
            </li>
            <li>
              <b><code>class_topred</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="set">set</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Mapping from class name to set of valid labels.</p>
              </div>
            </li>
            <li>
              <b><code>labels_groupings</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Hierarchical groupings for ontology classes.</p>
              </div>
            </li>
            <li>
              <b><code>encoder</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Label encoders mapping strings to integers.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If genedf is None and "organism_ontology_term_id" is not in clss_to_predict.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>collection = ln.Collection.filter(key="my_collection").first()
dataset = Dataset(
...     lamin_dataset=collection,
...     clss_to_predict=["organism_ontology_term_id", "cell_type_ontology_term_id"],
...     hierarchical_clss=["cell_type_ontology_term_id"],
... )
sample = dataset[0]  # Returns dict with "X" and encoded labels</p>
</blockquote>
</blockquote>
</blockquote>
</details>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="define_hierarchies (scdataloader.data.Dataset.define_hierarchies)" href="#scdataloader.data.Dataset.define_hierarchies">define_hierarchies</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Define hierarchical label groupings from ontology relationships.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_label_cats (scdataloader.data.Dataset.get_label_cats)" href="#scdataloader.data.Dataset.get_label_cats">get_label_cats</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get combined categorical codes for one or more label columns.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="get_unseen_mapped_dataset_elements (scdataloader.data.Dataset.get_unseen_mapped_dataset_elements)" href="#scdataloader.data.Dataset.get_unseen_mapped_dataset_elements">get_unseen_mapped_dataset_elements</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Get genes marked as unseen for a specific sample.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>






  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="scdataloader.data.Dataset.define_hierarchies" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">define_hierarchies</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Define hierarchical label groupings from ontology relationships.</p>
<p>Uses Bionty to retrieve parent-child relationships for ontology terms,
then builds groupings mapping parent terms to their descendants.
Updates encoders to include parent terms and reorders labels so that
leaf terms (directly predictable) come first.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>clsses</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>)
              –
              <div class="doc-md-description">
                <p>List of ontology column names to process.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If a class name is not in the supported ontology types.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="note" open>
  <summary>Note</summary>
  <p>Modifies self.labels_groupings, self.class_topred, and
self.mapped_dataset.encoders in place.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scdataloader/data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">define_hierarchies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clsses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define hierarchical label groupings from ontology relationships.</span>

<span class="sd">    Uses Bionty to retrieve parent-child relationships for ontology terms,</span>
<span class="sd">    then builds groupings mapping parent terms to their descendants.</span>
<span class="sd">    Updates encoders to include parent terms and reorders labels so that</span>
<span class="sd">    leaf terms (directly predictable) come first.</span>

<span class="sd">    Args:</span>
<span class="sd">        clsses (List[str]): List of ontology column names to process.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If a class name is not in the supported ontology types.</span>

<span class="sd">    Note:</span>
<span class="sd">        Modifies self.labels_groupings, self.class_topred, and</span>
<span class="sd">        self.mapped_dataset.encoders in place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: use all possible hierarchies instead of just the ones for which we have a sample annotated with</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">labels_groupings</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">class_topred</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">clss</span> <span class="ow">in</span> <span class="n">clsses</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">clss</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tissue_ontology_term_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disease_ontology_term_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;development_stage_ontology_term_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;simplified_dev_stage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age_group&quot;</span><span class="p">,</span>
            <span class="s2">&quot;assay_ontology_term_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;self_reported_ethnicity_ontology_term_id&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;class </span><span class="si">{}</span><span class="s2"> not in accepted classes, for now only supported from bionty sources&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">clss</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">clss</span> <span class="o">==</span> <span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">:</span>
            <span class="n">parentdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span>
                    <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ontology_id&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ontology_id&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">clss</span> <span class="o">==</span> <span class="s2">&quot;tissue_ontology_term_id&quot;</span><span class="p">:</span>
            <span class="n">parentdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">Tissue</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span>
                    <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ontology_id&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ontology_id&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">clss</span> <span class="o">==</span> <span class="s2">&quot;disease_ontology_term_id&quot;</span><span class="p">:</span>
            <span class="n">parentdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">Disease</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span>
                    <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ontology_id&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ontology_id&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">clss</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;development_stage_ontology_term_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;simplified_dev_stage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age_group&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">parentdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">DevelopmentalStage</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span>
                    <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ontology_id&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ontology_id&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">clss</span> <span class="o">==</span> <span class="s2">&quot;assay_ontology_term_id&quot;</span><span class="p">:</span>
            <span class="n">parentdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">ExperimentalFactor</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span>
                    <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ontology_id&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ontology_id&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">clss</span> <span class="o">==</span> <span class="s2">&quot;self_reported_ethnicity_ontology_term_id&quot;</span><span class="p">:</span>
            <span class="n">parentdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">Ethnicity</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span>
                    <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ontology_id&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ontology_id&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;class </span><span class="si">{}</span><span class="s2"> not in accepted classes, for now only supported from bionty sources&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">clss</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">cats</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">groupings</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">leaf_labels</span> <span class="o">=</span> <span class="n">get_ancestry_mapping</span><span class="p">(</span><span class="n">cats</span><span class="p">,</span> <span class="n">parentdf</span><span class="p">)</span>
        <span class="n">groupings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">groupings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># that should not happen</span>
                <span class="kn">import</span> <span class="nn">pdb</span>

                <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
                <span class="n">groupings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">labels_groupings</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span> <span class="o">=</span> <span class="n">groupings</span>
        <span class="k">if</span> <span class="n">clss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clss_to_predict</span><span class="p">:</span>
            <span class="c1"># if we have added new clss, we need to update the encoder with them too.</span>
            <span class="n">mlength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">clss</span><span class="p">])</span>

            <span class="n">mlength</span> <span class="o">-=</span> <span class="p">(</span>
                <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">unknown_label</span>
                <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">groupings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">v</span><span class="p">:</span> <span class="n">mlength</span> <span class="o">+</span> <span class="n">i</span><span class="p">})</span>

            <span class="c1"># we need to change the ordering so that the things that can&#39;t be predicted appear afterward</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_topred</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span> <span class="o">=</span> <span class="n">leaf_labels</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">update</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mlength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaf_labels</span><span class="p">)</span>
            <span class="n">mlength</span> <span class="o">-=</span> <span class="p">(</span>
                <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">unknown_label</span>
                <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_groupings</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">update</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">mlength</span> <span class="o">+</span> <span class="n">c</span><span class="p">})</span>
                    <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">unknown_label</span><span class="p">:</span>
                    <span class="n">update</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">class_topred</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">([</span><span class="n">k</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">update</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="o">-</span> <span class="n">c</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">encoders</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span> <span class="o">=</span> <span class="n">update</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scdataloader.data.Dataset.get_label_cats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_label_cats</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get combined categorical codes for one or more label columns.</p>
<p>Retrieves labels from the mapped dataset and combines them into a single
categorical encoding. Useful for creating compound class labels for
stratified sampling.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>obs_keys</code></b>
                  (<code><span title="str">str</span> | <span title="typing.List">List</span>[<span title="str">str</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Column name(s) to retrieve and combine.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>np.ndarray: Integer codes representing the (combined) categories.
Shape: (n_samples,).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scdataloader/data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_label_cats</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">obs_keys</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get combined categorical codes for one or more label columns.</span>

<span class="sd">    Retrieves labels from the mapped dataset and combines them into a single</span>
<span class="sd">    categorical encoding. Useful for creating compound class labels for</span>
<span class="sd">    stratified sampling.</span>

<span class="sd">    Args:</span>
<span class="sd">        obs_keys (str | List[str]): Column name(s) to retrieve and combine.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Integer codes representing the (combined) categories.</span>
<span class="sd">            Shape: (n_samples,).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">obs_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_keys</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">label_key</span> <span class="ow">in</span> <span class="n">obs_keys</span><span class="p">:</span>
        <span class="n">labels_to_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">get_merged_labels</span><span class="p">(</span><span class="n">label_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels_to_str</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">concat_categorical_codes</span><span class="p">([</span><span class="n">labels</span><span class="p">,</span> <span class="n">labels_to_str</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">codes</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scdataloader.data.Dataset.get_unseen_mapped_dataset_elements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_unseen_mapped_dataset_elements</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get genes marked as unseen for a specific sample.</p>
<p>Retrieves the list of genes that were not observed (expression = 0 or
marked as unseen) for the sample at the given index.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>idx</code></b>
                  (<code><span title="int">int</span></code>)
              –
              <div class="doc-md-description">
                <p>Sample index in the dataset.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
              –
              <div class="doc-md-description">
                <p>List[str]: List of unseen gene identifiers.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scdataloader/data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_unseen_mapped_dataset_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get genes marked as unseen for a specific sample.</span>

<span class="sd">    Retrieves the list of genes that were not observed (expression = 0 or</span>
<span class="sd">    marked as unseen) for the sample at the given index.</span>

<span class="sd">    Args:</span>
<span class="sd">        idx (int): Sample index in the dataset.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[str]: List of unseen gene identifiers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped_dataset</span><span class="o">.</span><span class="n">uns</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;unseen_genes&quot;</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>


</div>

<div class="doc doc-object doc-class">



<h2 id="scdataloader.data.SimpleAnnDataset" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">scdataloader</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">SimpleAnnDataset</span></code>

</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.utils.data.Dataset">Dataset</span></code></p>



        <p>Simple PyTorch Dataset wrapper for a single AnnData object.</p>
<p>Provides a lightweight interface for using AnnData with PyTorch DataLoaders,
compatible with the scDataLoader collator. Useful for inference on new data
that isn't stored in LaminDB.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>AnnData object containing expression data.</p>
              </div>
            </li>
            <li>
              <b><code>obs_to_output</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
                <p>Observation columns to include in
output dictionaries. Defaults to [].</p>
              </div>
            </li>
            <li>
              <b><code>layer</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Layer name to use for expression values. If None,
uses adata.X. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>get_knn_cells</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to include k-nearest neighbor
expression data. Requires precomputed neighbors in adata.obsp.
Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>encoder</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="dict">dict</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Dictionary mapping observation column
names to encoding dictionaries (str -&gt; int). Defaults to None.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Attributes:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>adataX</code></b>
                  (<code><span title="numpy.ndarray">ndarray</span></code>)
              –
              <div class="doc-md-description">
                <p>Dense expression matrix.</p>
              </div>
            </li>
            <li>
              <b><code>encoder</code></b>
                  (<code><span title="dict">dict</span></code>)
              –
              <div class="doc-md-description">
                <p>Label encoders.</p>
              </div>
            </li>
            <li>
              <b><code>obs_to_output</code></b>
                  (<code><span title="pandas.DataFrame">DataFrame</span></code>)
              –
              <div class="doc-md-description">
                <p>Observation metadata to include.</p>
              </div>
            </li>
            <li>
              <b><code>distances</code></b>
                  (<code>scipy.sparse matrix</code>)
              –
              <div class="doc-md-description">
                <p>KNN distance matrix (if get_knn_cells=True).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If get_knn_cells=True but "connectivities" not in adata.obsp.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>dataset = SimpleAnnDataset(
...     adata=my_adata,
...     obs_to_output=["cell_type", "organism_ontology_term_id"],
...     encoder={"organism_ontology_term_id": {"NCBITaxon:9606": 0}},
... )
loader = DataLoader(dataset, batch_size=32, collate_fn=collator)</p>
</blockquote>
</blockquote>
</blockquote>
</details>











                  <details class="quote">
                    <summary>Source code in <code>scdataloader/data.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
    <span class="n">obs_to_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">get_knn_cells</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">encoder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple PyTorch Dataset wrapper for a single AnnData object.</span>

<span class="sd">    Provides a lightweight interface for using AnnData with PyTorch DataLoaders,</span>
<span class="sd">    compatible with the scDataLoader collator. Useful for inference on new data</span>
<span class="sd">    that isn&#39;t stored in LaminDB.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata (AnnData): AnnData object containing expression data.</span>
<span class="sd">        obs_to_output (List[str], optional): Observation columns to include in</span>
<span class="sd">            output dictionaries. Defaults to [].</span>
<span class="sd">        layer (str, optional): Layer name to use for expression values. If None,</span>
<span class="sd">            uses adata.X. Defaults to None.</span>
<span class="sd">        get_knn_cells (bool, optional): Whether to include k-nearest neighbor</span>
<span class="sd">            expression data. Requires precomputed neighbors in adata.obsp.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        encoder (dict[str, dict], optional): Dictionary mapping observation column</span>
<span class="sd">            names to encoding dictionaries (str -&gt; int). Defaults to None.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        adataX (np.ndarray): Dense expression matrix.</span>
<span class="sd">        encoder (dict): Label encoders.</span>
<span class="sd">        obs_to_output (pd.DataFrame): Observation metadata to include.</span>
<span class="sd">        distances (scipy.sparse matrix): KNN distance matrix (if get_knn_cells=True).</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If get_knn_cells=True but &quot;connectivities&quot; not in adata.obsp.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; dataset = SimpleAnnDataset(</span>
<span class="sd">        ...     adata=my_adata,</span>
<span class="sd">        ...     obs_to_output=[&quot;cell_type&quot;, &quot;organism_ontology_term_id&quot;],</span>
<span class="sd">        ...     encoder={&quot;organism_ontology_term_id&quot;: {&quot;NCBITaxon:9606&quot;: 0}},</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; loader = DataLoader(dataset, batch_size=32, collate_fn=collator)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adataX</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adataX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adataX</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span> <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adataX</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">adataX</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span> <span class="k">if</span> <span class="n">encoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">obs_to_output</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">obs_to_output</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_knn_cells</span> <span class="o">=</span> <span class="n">get_knn_cells</span>
    <span class="k">if</span> <span class="n">get_knn_cells</span> <span class="ow">and</span> <span class="s2">&quot;connectivities&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsp</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;neighbors key not found in adata.obsm&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">get_knn_cells</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distances</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">












  </div>

    </div>


</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../notebooks/2_create_dataloader/" class="btn btn-neutral float-left" title="Create the dataloader"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../preprocess/" class="btn btn-neutral float-right" title="preprocess">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../notebooks/2_create_dataloader/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../preprocess/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
