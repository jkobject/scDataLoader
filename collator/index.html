<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.jkobject.com/scdataloader/collator/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>collator - scdataloader</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "collator";
        var mkdocs_page_input_path = "collator.md";
        var mkdocs_page_url = "/scdataloader/collator/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> scdataloader
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Example notebooks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/1_download_and_preprocess/">one-off preparation and download of the database (optional)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/2_create_dataloader/">Create the dataloader</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">documentation</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../dataset/">dataset</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../preprocess/">preprocess</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../utils/">utils</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../datamodule/">datamodule</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">collator</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#scdataloader.collator.Collator">Collator</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scdataloader.collator.Collator.__call__">__call__</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">scdataloader</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">documentation</li>
      <li class="breadcrumb-item active">collator</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="documentation-for-collator">Documentation for <code>Collator</code></h1>


<div class="doc doc-object doc-class">



<h2 id="scdataloader.collator.Collator" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">scdataloader</span><span class="o">.</span><span class="n">collator</span><span class="o">.</span><span class="n">Collator</span></code>

</h2>


    <div class="doc doc-contents first">



        <p>Collator for preparing gene expression data batches for the scPRINT model.</p>
<p>This class handles the organization and preparation of gene expression data from
different organisms, allowing for various configurations such as maximum gene list
length, normalization, binning, and gene selection strategies.</p>
<p>Compatible with scVI's dataloader and other PyTorch data loading pipelines.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>organisms</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>)
              –
              <div class="doc-md-description">
                <p>List of organism ontology term IDs to include.
Samples from other organisms will be dropped (may lead to variable batch sizes).</p>
              </div>
            </li>
            <li>
              <b><code>how</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;all&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Gene selection strategy. Defaults to "all".
- "most expr": Select the <code>max_len</code> most expressed genes. If fewer genes
  are expressed, randomly sample unexpressed genes to fill.
- "random expr": Randomly select <code>max_len</code> expressed genes. If fewer genes
  are expressed, randomly sample unexpressed genes to fill.
- "all": Use all genes without filtering.
- "some": Use only genes specified in the <code>genelist</code> parameter.</p>
              </div>
            </li>
            <li>
              <b><code>org_to_id</code></b>
                  (<code><span title="dict">dict</span>[<span title="str">str</span>, <span title="int">int</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Mapping from organism names to integer IDs.
If None, organism names are used directly. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>valid_genes</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>List of gene names to consider from input data.
Genes not in this list will be dropped. Useful when the model only supports
specific genes. Defaults to None (use all genes).</p>
              </div>
            </li>
            <li>
              <b><code>max_len</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>2000</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of genes to include when using "most expr"
or "random expr" selection methods. Defaults to 2000.</p>
              </div>
            </li>
            <li>
              <b><code>add_zero_genes</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Number of additional unexpressed genes to include
in the output. Only applies when <code>how</code> is "most expr" or "random expr".
Defaults to 0.</p>
              </div>
            </li>
            <li>
              <b><code>logp1</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Apply log2(1 + x) transformation to expression values.
Applied after normalization if both are enabled. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>norm_to</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Target sum for count normalization. Expression values
are scaled so that total counts equal this value. Defaults to None (no normalization).</p>
              </div>
            </li>
            <li>
              <b><code>n_bins</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Number of bins for expression value binning. If 0, no
binning is applied. Binning uses quantile-based discretization. Defaults to 0.</p>
              </div>
            </li>
            <li>
              <b><code>tp_name</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Column name in batch data for time point or heat diffusion
values. If None, time point values default to 0. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>organism_name</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;organism_ontology_term_id&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Column name in batch data for organism ontology
term ID. Defaults to "organism_ontology_term_id".</p>
              </div>
            </li>
            <li>
              <b><code>class_names</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
                <p>List of additional metadata column names to
include in the output. Defaults to [].</p>
              </div>
            </li>
            <li>
              <b><code>genelist</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
                <p>List of specific genes to use when <code>how="some"</code>.
Required if <code>how="some"</code>. Defaults to [].</p>
              </div>
            </li>
            <li>
              <b><code>genedf</code></b>
                  (<code><span title="pandas.DataFrame">DataFrame</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>DataFrame containing gene information indexed by
gene name with an 'organism' column. If None, loaded automatically using
<code>load_genes()</code>. Defaults to None.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Attributes:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>organism_ids</code></b>
                  (<code><span title="set">set</span></code>)
              –
              <div class="doc-md-description">
                <p>Set of organism IDs being processed.</p>
              </div>
            </li>
            <li>
              <b><code>start_idx</code></b>
                  (<code><span title="dict">dict</span></code>)
              –
              <div class="doc-md-description">
                <p>Mapping from organism ID to starting gene index in the model.</p>
              </div>
            </li>
            <li>
              <b><code>accepted_genes</code></b>
                  (<code><span title="dict">dict</span></code>)
              –
              <div class="doc-md-description">
                <p>Boolean masks for valid genes per organism.</p>
              </div>
            </li>
            <li>
              <b><code>to_subset</code></b>
                  (<code><span title="dict">dict</span></code>)
              –
              <div class="doc-md-description">
                <p>Boolean masks for genelist filtering per organism.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="AssertionError">AssertionError</span></code>
              –
              <div class="doc-md-description">
                <p>If <code>how="some"</code> but <code>genelist</code> is empty.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="__call__ (scdataloader.collator.Collator.__call__)" href="#scdataloader.collator.Collator.__call__">__call__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Collate a minibatch of gene expression data.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



                  <details class="quote">
                    <summary>Source code in <code>scdataloader/collator.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">organisms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">how</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">org_to_id</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">valid_genes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">add_zero_genes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">logp1</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">norm_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">tp_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">organism_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">,</span>
    <span class="n">class_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">genelist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">genedf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collator for preparing gene expression data batches for the scPRINT model.</span>

<span class="sd">    This class handles the organization and preparation of gene expression data from</span>
<span class="sd">    different organisms, allowing for various configurations such as maximum gene list</span>
<span class="sd">    length, normalization, binning, and gene selection strategies.</span>

<span class="sd">    Compatible with scVI&#39;s dataloader and other PyTorch data loading pipelines.</span>

<span class="sd">    Args:</span>
<span class="sd">        organisms (List[str]): List of organism ontology term IDs to include.</span>
<span class="sd">            Samples from other organisms will be dropped (may lead to variable batch sizes).</span>
<span class="sd">        how (str, optional): Gene selection strategy. Defaults to &quot;all&quot;.</span>
<span class="sd">            - &quot;most expr&quot;: Select the `max_len` most expressed genes. If fewer genes</span>
<span class="sd">              are expressed, randomly sample unexpressed genes to fill.</span>
<span class="sd">            - &quot;random expr&quot;: Randomly select `max_len` expressed genes. If fewer genes</span>
<span class="sd">              are expressed, randomly sample unexpressed genes to fill.</span>
<span class="sd">            - &quot;all&quot;: Use all genes without filtering.</span>
<span class="sd">            - &quot;some&quot;: Use only genes specified in the `genelist` parameter.</span>
<span class="sd">        org_to_id (dict[str, int], optional): Mapping from organism names to integer IDs.</span>
<span class="sd">            If None, organism names are used directly. Defaults to None.</span>
<span class="sd">        valid_genes (List[str], optional): List of gene names to consider from input data.</span>
<span class="sd">            Genes not in this list will be dropped. Useful when the model only supports</span>
<span class="sd">            specific genes. Defaults to None (use all genes).</span>
<span class="sd">        max_len (int, optional): Maximum number of genes to include when using &quot;most expr&quot;</span>
<span class="sd">            or &quot;random expr&quot; selection methods. Defaults to 2000.</span>
<span class="sd">        add_zero_genes (int, optional): Number of additional unexpressed genes to include</span>
<span class="sd">            in the output. Only applies when `how` is &quot;most expr&quot; or &quot;random expr&quot;.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        logp1 (bool, optional): Apply log2(1 + x) transformation to expression values.</span>
<span class="sd">            Applied after normalization if both are enabled. Defaults to False.</span>
<span class="sd">        norm_to (float, optional): Target sum for count normalization. Expression values</span>
<span class="sd">            are scaled so that total counts equal this value. Defaults to None (no normalization).</span>
<span class="sd">        n_bins (int, optional): Number of bins for expression value binning. If 0, no</span>
<span class="sd">            binning is applied. Binning uses quantile-based discretization. Defaults to 0.</span>
<span class="sd">        tp_name (str, optional): Column name in batch data for time point or heat diffusion</span>
<span class="sd">            values. If None, time point values default to 0. Defaults to None.</span>
<span class="sd">        organism_name (str, optional): Column name in batch data for organism ontology</span>
<span class="sd">            term ID. Defaults to &quot;organism_ontology_term_id&quot;.</span>
<span class="sd">        class_names (List[str], optional): List of additional metadata column names to</span>
<span class="sd">            include in the output. Defaults to [].</span>
<span class="sd">        genelist (List[str], optional): List of specific genes to use when `how=&quot;some&quot;`.</span>
<span class="sd">            Required if `how=&quot;some&quot;`. Defaults to [].</span>
<span class="sd">        genedf (pd.DataFrame, optional): DataFrame containing gene information indexed by</span>
<span class="sd">            gene name with an &#39;organism&#39; column. If None, loaded automatically using</span>
<span class="sd">            `load_genes()`. Defaults to None.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        organism_ids (set): Set of organism IDs being processed.</span>
<span class="sd">        start_idx (dict): Mapping from organism ID to starting gene index in the model.</span>
<span class="sd">        accepted_genes (dict): Boolean masks for valid genes per organism.</span>
<span class="sd">        to_subset (dict): Boolean masks for genelist filtering per organism.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If `how=&quot;some&quot;` but `genelist` is empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">organisms</span> <span class="o">=</span> <span class="n">organisms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">=</span> <span class="n">n_bins</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_zero_genes</span> <span class="o">=</span> <span class="n">add_zero_genes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logp1</span> <span class="o">=</span> <span class="n">logp1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">norm_to</span> <span class="o">=</span> <span class="n">norm_to</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">=</span> <span class="n">how</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;some&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">genelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;if how is some, genelist must be provided&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">organism_name</span> <span class="o">=</span> <span class="n">organism_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tp_name</span> <span class="o">=</span> <span class="n">tp_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">class_names</span> <span class="o">=</span> <span class="n">class_names</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_idx</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accepted_genes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">to_subset</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">genedf</span><span class="p">,</span> <span class="n">org_to_id</span><span class="p">,</span> <span class="n">valid_genes</span><span class="p">,</span> <span class="n">genelist</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="scdataloader.collator.Collator.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Collate a minibatch of gene expression data.</p>
<p>Processes a list of sample dictionaries, applying gene selection, normalization,
log transformation, and binning as configured. Filters out samples from organisms
not in the configured organism list.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>batch</code></b>
                  (<code><span title="typing.List">List</span>[<span title="dict">dict</span>]</code>)
              –
              <div class="doc-md-description">
                <p>List of sample dictionaries, each containing:
- "X" (array): Gene expression values.
- organism_name (any): Organism identifier (column name set by <code>organism_name</code>).
- tp_name (float, optional): Time point value (column name set by <code>tp_name</code>).
- class_names... (any, optional): Additional class labels.
- "_storage_idx" (int, optional): Dataset storage index.
- "is_meta" (int, optional): Metadata flag.
- "knn_cells" (array, optional): KNN neighbor expression data.
- "knn_cells_info" (array, optional): KNN neighbor metadata.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="torch.Tensor">Tensor</span>]</code>
              –
              <div class="doc-md-description">
                <p>dict[str, Tensor]: Dictionary containing collated tensors:
- "x" (Tensor): Gene expression matrix of shape (batch_size, n_genes).
  Values may be raw counts, normalized, log-transformed, or binned
  depending on configuration.
- "genes" (Tensor): Gene indices of shape (batch_size, n_genes) as int32.
  Indices correspond to positions in the model's gene vocabulary.
- "class" (Tensor): Class labels of shape (batch_size, n_classes) as int32.
- "tp" (Tensor): Time point values of shape (batch_size,).
- "depth" (Tensor): Total counts per cell of shape (batch_size,).
- "is_meta" (Tensor, optional): Metadata flags as int32. Present if input
  contains "is_meta".
- "knn_cells" (Tensor, optional): KNN expression data. Present if input
  contains "knn_cells".
- "knn_cells_info" (Tensor, optional): KNN metadata. Present if input
  contains "knn_cells_info".
- "dataset" (Tensor, optional): Dataset indices as int64. Present if input
  contains "_storage_idx".</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="note" open>
  <summary>Note</summary>
  <p>Batch size in output may be smaller than input if some samples are filtered
out due to organism mismatch.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scdataloader/collator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collate a minibatch of gene expression data.</span>

<span class="sd">    Processes a list of sample dictionaries, applying gene selection, normalization,</span>
<span class="sd">    log transformation, and binning as configured. Filters out samples from organisms</span>
<span class="sd">    not in the configured organism list.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (List[dict]): List of sample dictionaries, each containing:</span>
<span class="sd">            - &quot;X&quot; (array): Gene expression values.</span>
<span class="sd">            - organism_name (any): Organism identifier (column name set by `organism_name`).</span>
<span class="sd">            - tp_name (float, optional): Time point value (column name set by `tp_name`).</span>
<span class="sd">            - class_names... (any, optional): Additional class labels.</span>
<span class="sd">            - &quot;_storage_idx&quot; (int, optional): Dataset storage index.</span>
<span class="sd">            - &quot;is_meta&quot; (int, optional): Metadata flag.</span>
<span class="sd">            - &quot;knn_cells&quot; (array, optional): KNN neighbor expression data.</span>
<span class="sd">            - &quot;knn_cells_info&quot; (array, optional): KNN neighbor metadata.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, Tensor]: Dictionary containing collated tensors:</span>
<span class="sd">            - &quot;x&quot; (Tensor): Gene expression matrix of shape (batch_size, n_genes).</span>
<span class="sd">              Values may be raw counts, normalized, log-transformed, or binned</span>
<span class="sd">              depending on configuration.</span>
<span class="sd">            - &quot;genes&quot; (Tensor): Gene indices of shape (batch_size, n_genes) as int32.</span>
<span class="sd">              Indices correspond to positions in the model&#39;s gene vocabulary.</span>
<span class="sd">            - &quot;class&quot; (Tensor): Class labels of shape (batch_size, n_classes) as int32.</span>
<span class="sd">            - &quot;tp&quot; (Tensor): Time point values of shape (batch_size,).</span>
<span class="sd">            - &quot;depth&quot; (Tensor): Total counts per cell of shape (batch_size,).</span>
<span class="sd">            - &quot;is_meta&quot; (Tensor, optional): Metadata flags as int32. Present if input</span>
<span class="sd">              contains &quot;is_meta&quot;.</span>
<span class="sd">            - &quot;knn_cells&quot; (Tensor, optional): KNN expression data. Present if input</span>
<span class="sd">              contains &quot;knn_cells&quot;.</span>
<span class="sd">            - &quot;knn_cells_info&quot; (Tensor, optional): KNN metadata. Present if input</span>
<span class="sd">              contains &quot;knn_cells_info&quot;.</span>
<span class="sd">            - &quot;dataset&quot; (Tensor, optional): Dataset indices as int64. Present if input</span>
<span class="sd">              contains &quot;_storage_idx&quot;.</span>

<span class="sd">    Note:</span>
<span class="sd">        Batch size in output may be smaller than input if some samples are filtered</span>
<span class="sd">        out due to organism mismatch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># do count selection</span>
    <span class="c1"># get the unseen info and don&#39;t add any unseen</span>
    <span class="c1"># get the I most expressed genes, add randomly some unexpressed genes that are not unseen</span>
    <span class="n">exprs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_count</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">other_classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gene_locs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nnz_loc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">is_meta</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">knn_cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">knn_cells_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="n">organism_id</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">organism_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">organism_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">organism_ids</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s2">&quot;_storage_idx&quot;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s2">&quot;_storage_idx&quot;</span><span class="p">])</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">])</span>
        <span class="n">total_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_genes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted_genes</span><span class="p">[</span><span class="n">organism_id</span><span class="p">]]</span>
            <span class="k">if</span> <span class="s2">&quot;knn_cells&quot;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                <span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">][</span>
                    <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_genes</span><span class="p">[</span><span class="n">organism_id</span><span class="p">]</span>
                <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most expr&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;knn_cells&quot;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                <span class="n">nnz_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expr</span> <span class="o">+</span> <span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnz_loc</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnz_loc</span><span class="p">)</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">expr</span> <span class="o">+</span> <span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">))[</span><span class="o">-</span><span class="p">(</span><span class="n">ma</span><span class="p">):][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nnz_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnz_loc</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnz_loc</span><span class="p">)</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">expr</span><span class="p">)[</span><span class="o">-</span><span class="p">(</span><span class="n">ma</span><span class="p">):][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># nnz_loc = [1] * 30_000</span>
            <span class="c1"># loc = np.argsort(expr)[-(self.max_len) :][::-1]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;random expr&quot;</span><span class="p">:</span>
            <span class="n">nnz_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">nnz_loc</span><span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">nnz_loc</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
                        <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="c1"># p=(expr.max() + (expr[nnz_loc])*19) / expr.max(), # 20 at most times more likely to be selected</span>
                    <span class="p">)</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnz_loc</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">nnz_loc</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;some&quot;</span><span class="p">]:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;how must be either most expr or random expr&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_zero_genes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnz_loc</span><span class="p">))</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="s2">&quot;some&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_zero_genes</span> <span class="o">+</span> <span class="p">(</span>
                <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnz_loc</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nnz_loc</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;knn_cells&quot;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                <span class="c1"># we complete with genes expressed in the knn</span>
                <span class="c1"># which is not a zero_loc in this context</span>
                <span class="n">knn_expr</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">knn_expr</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">available_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">available_knn_expr</span> <span class="o">=</span> <span class="n">knn_expr</span><span class="p">[</span><span class="n">available_indices</span><span class="p">]</span>
                <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">available_knn_expr</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_indices</span><span class="p">))</span>
                <span class="n">zero_loc</span> <span class="o">=</span> <span class="n">available_indices</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">[:</span><span class="n">selected</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zero_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">expr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">zero_loc</span> <span class="o">=</span> <span class="n">zero_loc</span><span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">zero_loc</span><span class="p">),</span>
                        <span class="n">ma</span><span class="p">,</span>
                        <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">loc</span><span class="p">,</span> <span class="n">zero_loc</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;knn_cells&quot;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
            <span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">][:,</span> <span class="n">loc</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;some&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;knn_cells&quot;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                <span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">][</span>
                    <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_subset</span><span class="p">[</span><span class="n">organism_id</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">to_subset</span><span class="p">[</span><span class="n">organism_id</span><span class="p">]]</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">to_subset</span><span class="p">[</span><span class="n">organism_id</span><span class="p">]]</span>
        <span class="n">exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;knn_cells&quot;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
            <span class="n">knn_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;knn_cells_info&quot;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
            <span class="n">knn_cells_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s2">&quot;knn_cells_info&quot;</span><span class="p">])</span>
        <span class="c1"># then we need to add the start_idx to the loc to give it the correct index</span>
        <span class="c1"># according to the model</span>
        <span class="n">gene_locs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_idx</span><span class="p">[</span><span class="n">organism_id</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tp_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;is_meta&quot;</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
            <span class="n">is_meta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s2">&quot;is_meta&quot;</span><span class="p">])</span>
        <span class="n">other_classes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">elem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_names</span><span class="p">])</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exprs</span><span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">gene_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gene_locs</span><span class="p">)</span>
    <span class="n">total_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">total_count</span><span class="p">)</span>
    <span class="n">other_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">other_classes</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">is_meta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">is_meta</span><span class="p">)</span>
    <span class="n">knn_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">knn_cells</span><span class="p">)</span>
    <span class="n">knn_cells_info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">knn_cells_info</span><span class="p">)</span>

    <span class="c1"># normalize counts</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="p">(</span><span class="n">expr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_to</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_count</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="c1"># TODO: solve issue here</span>
        <span class="n">knn_cells</span> <span class="o">=</span> <span class="p">(</span><span class="n">knn_cells</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_to</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_count</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logp1</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">expr</span><span class="p">)</span>
        <span class="n">knn_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">knn_cells</span><span class="p">)</span>

    <span class="c1"># do binning of counts</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">binned_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;The input data contains all zero rows. Please make sure &quot;</span>
                    <span class="s2">&quot;this is expected. You can use the `filter_cell_by_counts` &quot;</span>
                    <span class="s2">&quot;arg to filter out all zero rows.&quot;</span>
                <span class="p">)</span>
                <span class="n">binned_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
                <span class="n">bin_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">non_zero_ids</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
            <span class="n">non_zero_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">non_zero_ids</span><span class="p">]</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">non_zero_row</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1"># bins = np.sort(np.unique(bins))</span>
            <span class="c1"># NOTE: comment this line for now, since this will make the each category</span>
            <span class="c1"># has different relative meaning across datasets</span>
            <span class="n">non_zero_digits</span> <span class="o">=</span> <span class="n">_digitize</span><span class="p">(</span><span class="n">non_zero_row</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">non_zero_digits</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">non_zero_digits</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bins</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">binned_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">binned_row</span><span class="p">[</span><span class="n">non_zero_ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_zero_digits</span>
            <span class="n">binned_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binned_row</span><span class="p">)</span>
            <span class="n">bin_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="p">]))</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">binned_rows</span><span class="p">)</span>
        <span class="c1"># expr = np.digitize(expr, bins=self.bins)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span>
        <span class="s2">&quot;genes&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">gene_locs</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">(),</span>
        <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">other_classes</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">(),</span>
        <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">tp</span><span class="p">),</span>
        <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">total_count</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">is_meta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;is_meta&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">is_meta</span><span class="p">)</span><span class="o">.</span><span class="n">int</span><span class="p">()})</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">knn_cells</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">knn_cells</span><span class="p">)})</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">knn_cells_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;knn_cells_info&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">knn_cells_info</span><span class="p">)})</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">long</span><span class="p">)})</span>
    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>


</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../datamodule/" class="btn btn-neutral float-left" title="datamodule"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../datamodule/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
