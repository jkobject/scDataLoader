<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="None" /><link rel="canonical" href="https://www.jkobject.com/scdataloader/" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>scdataloader</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Home";
        var mkdocs_page_input_path = "index.md";
        var mkdocs_page_url = "/scdataloader/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="." class="icon icon-home"> scdataloader
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Home</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#more">More</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#install-it-from-pypi">Install it from PyPI</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#dev-install">Dev install</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#datamodule-usage">DataModule usage</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#lightning-free-usage-datasetcollatordataloader">lightning-free usage (Dataset+Collator+DataLoader)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#gathering-a-pre-training-database">Gathering a pre-training database</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#getting-all-of-cellxgene">Getting all of cellxgene</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#getting-the-rest-of-the-scprint-2-corpus">Getting the rest of the scPRINT-2 corpus</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#getting-even-more">Getting even more</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#command-line-usage-to-train-a-moel">command line usage to train a moel</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#faq">FAQ</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#how-to-update-my-ontologies">how to update my ontologies?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#how-to-load-all-ontologies">how to load all ontologies?</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#how-to-move-my-lamin-instance-to-another-folder">how to move my lamin instance to another folder?</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#development">Development</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#license">License</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#acknowledgments">Acknowledgments</a>
    </li>
    </ul>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Example notebooks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="notebooks/1_download_and_preprocess/">one-off preparation and download of the database (optional)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="notebooks/2_create_dataloader/">Create the dataloader</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="dataset/">dataset</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="preprocess/">preprocess</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="utils/">utils</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="datamodule/">datamodule</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="collator/">collator</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href=".">scdataloader</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Home</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="scdataloader">scdataloader</h1>
<p><img src="./scdataloader.png" width="600"></p>
<p>This single cell pytorch dataloader / lighting datamodule is designed to be used
with:</p>
<ul>
<li><a href="https://lamin.ai/">lamindb</a></li>
</ul>
<p>and:</p>
<ul>
<li><a href="https://scanpy.readthedocs.io/en/stable/">scanpy</a></li>
<li><a href="https://anndata.readthedocs.io/en/latest/">anndata</a></li>
</ul>
<p>It allows you to:</p>
<ol>
<li>load thousands of datasets containing millions of cells in a few seconds.</li>
<li>preprocess the data per dataset and download it locally (normalization,
   filtering, etc.)</li>
<li>create a more complex single cell dataset</li>
<li>extend it to your need</li>
</ol>
<p>built on top of <code>lamindb</code> and the <code>.mapped()</code> function by Sergei:
https://github.com/Koncopd</p>
<pre><code>Portions of the mapped.py file are derived from Lamin Labs
Copyright 2024 Lamin Labs
Licensed under the Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
The rest of the package is licensed under MIT License, see LICENSE for details
Please see https://github.com/laminlabs/lamindb/blob/main/lamindb/core/_mapped_collection.py
for the original implementation
</code></pre>
<p>The package has been designed together with the
<a href="https://doi.org/10.1101/2024.07.29.605556">scPRINT paper</a> and
<a href="https://github.com/cantinilab/scPRINT">model</a>.</p>
<h2 id="more">More</h2>
<p>I needed to create this Data Loader for my PhD project. I am using it to load &amp;
preprocess thousands of datasets containing millions of cells in a few seconds.
I believed that individuals employing AI for single-cell RNA sequencing and
other sequencing datasets would eagerly utilize and desire such a tool, which
presently does not exist.</p>
<p><img alt="scdataloader.drawio.png" src="scdataloader.drawio.png" /></p>
<h2 id="install-it-from-pypi">Install it from PyPI</h2>
<pre><code class="language-bash">pip install scdataloader
# or
pip install scDataLoader[dev] # for dev dependencies

lamin init --storage ./testdb --name test --schema bionty
</code></pre>
<p>if you start with lamin and had to do a <code>lamin init</code>, you will also need to
populate your ontologies. This is because scPRINT is using ontologies to define
its cell types, diseases, sexes, ethnicities, etc.</p>
<p>you can do it manually or with our function:</p>
<pre><code class="language-python">from scdataloader.utils import populate_my_ontology, _adding_scbasecamp_genes

populate_my_ontology() #to populate everything (recommended) (can take 2-10mns)

populate_my_ontology( #the minimum to the tool
organisms: List[str] = [&quot;NCBITaxon:10090&quot;, &quot;NCBITaxon:9606&quot;],
    sex: List[str] = [&quot;PATO:0000384&quot;, &quot;PATO:0000383&quot;],
    celltypes = None,
    ethnicities = None,
    assays = None,
    tissues = None,
    diseases = None,
    dev_stages = None,
)
# if you want to load the gene names and species for the arc scbasecount species, also add this:
_adding_scbasecamp_genes()
</code></pre>
<h3 id="dev-install">Dev install</h3>
<p>If you want to use the latest version of scDataLoader and work on the code
yourself use <code>git clone</code> and <code>pip -e</code> instead of <code>pip install</code>.</p>
<pre><code class="language-bash">git clone https://github.com/jkobject/scDataLoader.git
pip install -e scDataLoader[dev]
</code></pre>
<h2 id="usage">Usage</h2>
<h3 id="datamodule-usage">DataModule usage</h3>
<pre><code class="language-python"># initialize a local lamin database
#! lamin init --storage ./cellxgene --name cellxgene --schema bionty
from scdataloader import utils, Preprocessor, DataModule


# preprocess datasets
preprocessor = Preprocessor(
    do_postp=False,
    force_preprocess=True,
)
adata = preprocessor(adata)

art = ln.Artifact(adata, description=&quot;test&quot;)
art.save()
ln.Collection(art, name=&quot;test&quot;, description=&quot;test&quot;).save()

datamodule = DataModule(
    collection_name=&quot;test&quot;,
    organisms=[&quot;NCBITaxon:9606&quot;], #organism that we will work on
    how=&quot;most expr&quot;, # for the collator (most expr genes only will be selected)
    max_len=1000, # only the 1000 most expressed
    batch_size=64,
    num_workers=1,
    validation_split=0.1,
)
</code></pre>
<p>see the notebooks in <a href="https://www.jkobject.com/scDataLoader/">docs</a> to learn
more</p>
<ol>
<li><a href="https://www.jkobject.com/scDataLoader/notebooks/1_download_and_preprocess/">load a dataset</a></li>
<li><a href="https://www.jkobject.com/scDataLoader/notebooks/2_create_dataloader/">create a dataset</a></li>
</ol>
<h3 id="lightning-free-usage-datasetcollatordataloader">lightning-free usage (Dataset+Collator+DataLoader)</h3>
<pre><code class="language-python"># initialize a local lamin database
#! lamin init --storage ./cellxgene --name cellxgene --schema bionty

from scdataloader import utils, Preprocessor, SimpleAnnDataset, Collator, DataLoader

# preprocess dataset
preprocessor = Preprocessor(
    do_postp=False,
    force_preprocess=True,
)
adata = preprocessor(adata)

# create dataset
adataset = SimpleAnnDataset(
    adata, obs_to_output=[&quot;organism_ontology_term_id&quot;]
)
# create collator
col = Collator(
    organisms=&quot;NCBITaxon:9606&quot;,
    valid_genes=adata.var_names,
    max_len=2000, #maximum number of genes to use
    how=&quot;some&quot; |&quot;most expr&quot;|&quot;random_expr&quot;,
    # genelist = [geneA, geneB] if how=='some'
)
# create dataloader
dataloader = DataLoader(
    adataset,
    collate_fn=col,
    batch_size=64,
    num_workers=4,
    shuffle=False,
)

# predict
for batch in tqdm(dataloader):
    gene_pos, expression, depth = (
        batch[&quot;genes&quot;],
        batch[&quot;x&quot;],
        batch[&quot;depth&quot;],
    )
    model.predict(
        gene_pos,
        expression,
        depth,
    )
</code></pre>
<h2 id="gathering-a-pre-training-database">Gathering a pre-training database</h2>
<p>Here I will explain how to gather and preprocess all of cellxgene (scPRINT-1
pretraining database) with scDataLoader, and the scPRINT-2 corpus (scPRINT-2
pretraining database).</p>
<h3 id="getting-all-of-cellxgene">Getting all of cellxgene</h3>
<p>Here is an example of how to download and preprocess all of cellxgene with
scDataLoader as a script (a notebook version is also available in
<a href="https://github.com/jkobject/scdataloader/blob/main/notebooks/update_lamin_or_cellxgene.ipynb">./notebooks/update_lamin_or_cellxgene.ipynb</a>).</p>
<pre><code class="language-python"># initialize a local lamin database
#! lamin init --storage ./cellxgene --name cellxgene --schema bionty

from scdataloader import utils
from scdataloader.preprocess import LaminPreprocessor, additional_postprocess, additional_preprocess

# preprocess datasets
DESCRIPTION='preprocessed by scDataLoader'

cx_dataset = ln.Collection.using(instance=&quot;laminlabs/cellxgene&quot;).filter(name=&quot;cellxgene-census&quot;, version='2023-12-15').one()
cx_dataset, len(cx_dataset.artifacts.all())

# (OPTIONAL) if you want to do you preprocessing on a slurm cluster without internet connections,
# you can first do this:
load_dataset_local(
    cx_dataset,
    download_folder=&quot;/my_download_folder&quot;,
    name=&quot;cached-cellxgene-census&quot;,
    description=&quot;all of it topreprocess&quot;,
)

# preprocessing
do_preprocess = LaminPreprocessor(additional_postprocess=additional_postprocess, additional_preprocess=additional_preprocess, skip_validate=True, subset_hvg=0)

preprocessed_dataset = do_preprocess(cx_dataset, name=DESCRIPTION, description=DESCRIPTION, start_at=6, version=&quot;2&quot;)

</code></pre>
<p>After this you can use the preprocessed dataset with the DataModule below.</p>
<pre><code class="language-python"># create dataloaders
from scdataloader import DataModule
import tqdm

datamodule = DataModule(
    collection_name=&quot;preprocessed dataset&quot;,
    organisms=[&quot;NCBITaxon:9606&quot;], #organism that we will work on
    how=&quot;most expr&quot;, # for the collator (most expr genes only will be selected)
    max_len=1000, # only the 1000 most expressed
    batch_size=64,
    num_workers=1,
    validation_split=0.1,
    test_split=0)

for i in tqdm.tqdm(datamodule.train_dataloader()):
    # pass #or do pass
    print(i)
    break

# with lightning:
# Trainer(model, datamodule)
</code></pre>
<p>You can use the command line to preprocess a large database of datasets like
here for cellxgene. this allows parallelizing and easier usage.</p>
<pre><code class="language-bash">scdataloader --instance &quot;laminlabs/cellxgene&quot; --name &quot;cellxgene-census&quot; --version &quot;2023-12-15&quot; --description &quot;preprocessed for scprint&quot; --new_name &quot;scprint main&quot; --start_at 10 &gt;&gt; scdataloader.out
</code></pre>
<h3 id="getting-the-rest-of-the-scprint-2-corpus">Getting the rest of the scPRINT-2 corpus</h3>
<p>by now, using the command / scripts above you should be able to get all of
cellxgene (and preprocess it). laminlabs now also hosts the rest of the
scPRINT-2 corpus in <code>laminlabs/arc-virtual-cell-atlas</code> and they can be
downloaded and preprocessed the same way as cellxgene above. Be careful however
that there is no metadata for these datasets.</p>
<p>You can have a look at my notebooks:
<a href="https://github.com/jkobject/scdataloader/blob/main/notebooks/adding_tahoe.ipynb">./notebooks/adding_tahoe.ipynb</a>
and
<a href="https://github.com/jkobject/scdataloader/blob/main/notebooks/adding_scbasecount.ipynb">./notebooks/adding_scbasecount.ipynb</a>
where I create some remmaping to retrive metadata that can be used by
scdataloader and lamindb from these datasets.</p>
<p>If you do not have access for some reason to these datasets, please contact
laminlabs. But another solution, is to download them from the original sources
and add them one by one in your instance and then do the same preprocessing but
this time use <code>your_account/your_instance</code> instead of
<code>laminlabs/arc-virtual-cell-atlas</code>.</p>
<p>This is actually what I did in my own instance to create the full scPRINT-2
corpus and you can see some of it in the notebooks above.</p>
<h3 id="getting-even-more">Getting even more</h3>
<p>They also host a pertubation atlas in <code>laminlabs/pertdata</code> that can be
downloaded the same way.</p>
<h3 id="command-line-usage-to-train-a-moel">command line usage to train a moel</h3>
<p>The main way to use</p>
<blockquote>
<p>please refer to the <a href="https://www.jkobject.com/scPRINT/">scPRINT documentation</a>
and
<a href="https://lightning.ai/docs/pytorch/stable/cli/lightning_cli_intermediate.html">lightning documentation</a>
for more information on command line usage</p>
</blockquote>
<h2 id="faq">FAQ</h2>
<h3 id="how-to-update-my-ontologies">how to update my ontologies?</h3>
<pre><code class="language-bash">import bionty as bt
bt.reset_sources()

# Run via CLI: lamin load &lt;your instance&gt;

import lnschema_bionty as lb
lb.dev.sync_bionty_source_to_latest()
</code></pre>
<h3 id="how-to-load-all-ontologies">how to load all ontologies?</h3>
<pre><code class="language-python">from scdataloader import utils
utils.populate_ontologies() # this might take from 5-20mins
</code></pre>
<h3 id="how-to-move-my-lamin-instance-to-another-folder">how to move my lamin instance to another folder?</h3>
<p>you cannot just move your folder from one place to another because lamin is
using absolute paths. You need to do 3 things:</p>
<ol>
<li>move your folder to the new place</li>
<li>update your lamin config file (usually in <code>~/.lamin/my_env.yml</code>) to point to
   the new place</li>
<li>update the absolute paths in your lamin database. You can do it like this:</li>
</ol>
<pre><code class="language-python">import lamin as ln
ln.Storage.df()
# view what is your current storage id (in my case it was GZgLW1TQ)
ln.Storage.filter(uid=&quot;GZgLW1TI&quot;).update(
    root=Path(&quot;your_new_locations&quot;).as_posix().rstrip(&quot;/&quot;)
)
</code></pre>
<h2 id="development">Development</h2>
<p>Read the
<a href="https://github.com/jkobject/scdataloader/blob/main/CONTRIBUTING.md">CONTRIBUTING.md</a>
file.</p>
<h2 id="license">License</h2>
<p>This project is licensed under the MIT License - see the
<a href="https://github.com/jkobject/scdataloader/blob/main/LICENSE">LICENSE</a> file for
details.</p>
<h2 id="acknowledgments">Acknowledgments</h2>
<ul>
<li><a href="https://lamin.ai/">lamin.ai</a></li>
<li><a href="https://scanpy.readthedocs.io/en/stable/">scanpy</a></li>
<li><a href="https://anndata.readthedocs.io/en/latest/">anndata</a></li>
<li><a href="https://www.jkobject.com/scPRINT/">scprint</a></li>
</ul>
<p>Awesome single cell dataloader created by @jkobject</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="notebooks/1_download_and_preprocess/" class="btn btn-neutral float-right" title="one-off preparation and download of the database (optional)">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
      <span><a href="notebooks/1_download_and_preprocess/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script>var base_url = ".";</script>
    <script src="js/theme_extra.js"></script>
    <script src="js/theme.js"></script>
      <script src="search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>

<!--
MkDocs version : 1.6.1
Build Date UTC : 2025-12-19 14:40:39.931904+00:00
-->
